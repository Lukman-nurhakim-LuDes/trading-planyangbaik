<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Rencana Trading</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-20 lg:w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-center lg:justify-start p-4 lg:p-6 border-b border-gray-200 dark:border-gray-700">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    <h1 class="hidden lg:block ml-3 text-xl font-bold text-gray-800 dark:text-white">TradePlan</h1>
                </div>
                <ul id="nav-menu" class="mt-6">
                    <li data-view="dashboard" class="nav-item active-nav"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Dasbor</span></a></li>
                    <li data-view="journal" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="book-open" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Jurnal</span></a></li>
                    <li data-view="plan" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="list-checks" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Rencana</span></a></li>
                    <li data-view="calculator" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="calculator" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Kalkulator</span></a></li>
                    <li data-view="profile" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="user-circle" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Profil</span></a></li>
                </ul>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="hidden lg:block mb-4">
                    <p id="profile-name-display" class="font-semibold text-gray-800 dark:text-gray-100">Trader</p>
                    <p id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400 break-words">Loading...</p>
                </div>
                <button id="theme-toggle" class="w-full flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="sun" class="w-5 h-5"></i>
                    <span class="hidden lg:block ml-4">Ganti Tema</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto">
            <!-- Loading Spinner -->
            <div id="loading-view" class="flex items-center justify-center h-full">
                <p class="text-lg text-gray-700 dark:text-gray-300">Memuat data...</p>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="view p-4 md:p-6 space-y-6">
                <!-- Content will be generated by JavaScript -->
            </div>

            <!-- Journal View -->
            <div id="journal-view" class="view p-4 md:p-6 space-y-6">
                <!-- Content will be generated by JavaScript -->
            </div>

            <!-- Plan View -->
            <div id="plan-view" class="view p-4 md:p-6 space-y-6">
                <!-- Content will be generated by JavaScript -->
            </div>

            <!-- Calculator View -->
            <div id="calculator-view" class="view p-4 md:p-6 space-y-6">
                <!-- Content will be generated by JavaScript -->
            </div>

            <!-- Profile View -->
            <div id="profile-view" class="view p-4 md:p-6 space-y-6">
                <!-- Content will be generated by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ANDA ---
        // Ganti dengan konfigurasi dari proyek Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAPKJfQpYiZkFoIdvZaI2cAQ-Z50mu_gM8",
            authDomain: "trading-plan-416fb.firebaseapp.com",
            projectId: "trading-plan-416fb",
            storageBucket: "trading-plan-416fb.appspot.com",
            messagingSenderId: "140608805879",
            appId: "1:140608805879:web:6ce3def86c9689c2786cf2",
            measurementId: "G-5EGLDF7228"
        };
        const appId = 'trading-plan-416fb'; // Gunakan ID proyek Anda agar konsisten

        // --- Inisialisasi Aplikasi ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let trades = [];
        let plan = {};
        let profile = {};
        let pnlChart = null;
        let winLossChart = null;
        
        // --- State and DOM Elements ---
        const views = {
            dashboard: document.getElementById('dashboard-view'),
            journal: document.getElementById('journal-view'),
            plan: document.getElementById('plan-view'),
            calculator: document.getElementById('calculator-view'),
            profile: document.getElementById('profile-view'),
        };
        const navMenu = document.getElementById('nav-menu');
        const mainContent = document.getElementById('main-content');
        const loadingView = document.getElementById('loading-view');
        const profileNameDisplay = document.getElementById('profile-name-display');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Templating Functions ---
        const createDashboardHTML = () => `
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Dasbor Performa</h1>
            <div id="dashboard-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            <div id="dashboard-progress"></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-gray-700 dark:text-gray-300">P/L per Trade</h3>
                    <canvas id="pnlChart"></canvas>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-gray-700 dark:text-gray-300">Distribusi Win/Loss</h3>
                    <canvas id="winLossChart"></canvas>
                </div>
            </div>`;
        
        const createJournalHTML = () => `
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Jurnal Trading</h1>
                <button id="add-trade-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Tambah Trade
                </button>
            </div>
            <form id="trade-form" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4">
                <!-- Form fields will be inserted here -->
            </form>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Pair</th>
                            <th scope="col" class="px-6 py-3">Hasil</th><th scope="col" class="px-6 py-3">P/L ($)</th>
                            <th scope="col" class="px-6 py-3">Alasan</th><th scope="col" class="px-6 py-3">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="journal-table-body"></tbody>
                </table>
            </div>`;
        
        const createPlanHTML = () => `
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Rencana Trading Anda</h1>
            <form id="plan-form" class="space-y-8"></form>`;
            
        const createCalculatorHTML = () => `
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Kalkulator Risiko & Ukuran Lot</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Parameter</h2>
                    <div id="calculator-inputs"></div>
                </div>
                <div id="calculator-result" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow flex flex-col justify-center items-center"></div>
            </div>`;
            
        const createProfileHTML = () => `
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Profil Pengguna</h1>
            <div class="max-w-md">
                <form id="profile-form" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Pengguna</label>
                        <input type="text" name="name" placeholder="Masukkan nama Anda" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Simpan Profil</button>
                </form>
            </div>`;

        // --- Rendering Functions ---
        function renderDashboard() {
            views.dashboard.innerHTML = createDashboardHTML();
            const stats = calculateStats();
            
            document.getElementById('dashboard-stats').innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500 dark:text-gray-400 font-medium">Total P/L</h4><p class="text-2xl font-bold ${stats.totalPnl >= 0 ? 'text-green-500' : 'text-red-500'}">$${stats.totalPnl.toFixed(2)}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500 dark:text-gray-400 font-medium">Win Rate</h4><p class="text-2xl font-bold text-gray-800 dark:text-gray-100">${stats.winRate.toFixed(1)}%</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500 dark:text-gray-400 font-medium">Avg. R/R</h4><p class="text-2xl font-bold text-gray-800 dark:text-gray-100">${stats.averageRiskReward.toFixed(2)}:1</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500 dark:text-gray-400 font-medium">Total Trade</h4><p class="text-2xl font-bold text-gray-800 dark:text-gray-100">${trades.length}</p></div>
            `;
            
            const monthlyTarget = parseFloat(plan.monthlyTarget) || 1000;
            const progress = Math.max(0, (stats.totalPnl / monthlyTarget) * 100);
            document.getElementById('dashboard-progress').innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Progres Target Bulanan ($${monthlyTarget.toFixed(2)})</h3>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                    <div class="bg-blue-600 h-4 rounded-full" style="width: ${Math.min(progress, 100)}%;"></div>
                </div>
                <p class="text-right text-sm mt-1 text-gray-500 dark:text-gray-400">${progress.toFixed(1)}% tercapai</p>
            `;

            renderCharts(stats);
        }

        function renderJournal() {
            views.journal.innerHTML = createJournalHTML();
            const form = document.getElementById('trade-form');
            form.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal</label><input type="date" name="date" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md" value="${new Date().toISOString().split('T')[0]}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pair/Symbol</label><input type="text" name="pair" placeholder="e.g., BTC/USD" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ukuran Lot</label><input type="number" step="0.01" name="lotSize" placeholder="e.g., 0.01" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Harga Entry</label><input type="number" step="any" name="entryPrice" placeholder="e.g., 68000" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Stop Loss</label><input type="number" step="any" name="stopLoss" placeholder="e.g., 67000" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Take Profit</label><input type="number" step="any" name="takeProfit" placeholder="e.g., 70000" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hasil</label><select name="result" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"><option value="win">Win</option><option value="loss">Loss</option><option value="breakeven">Break Even</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profit/Loss ($)</label><input type="number" step="any" name="pnl" placeholder="e.g., 150" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Alasan Entry / Catatan</label><textarea name="reason" rows="3" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md" placeholder="e.g., Break of structure on H1..."></textarea></div>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Simpan Trade</button>`;
            
            document.getElementById('add-trade-btn').addEventListener('click', () => form.classList.toggle('hidden'));
            form.addEventListener('submit', handleAddTrade);
            
            renderJournalTable();
        }

        function renderJournalTable() {
            const tableBody = document.getElementById('journal-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = trades.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).map(trade => `
                <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <td class="px-6 py-4">${trade.date}</td>
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${trade.pair}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${trade.result === 'win' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : trade.result === 'loss' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200'}">${trade.result}</span></td>
                    <td class="px-6 py-4 font-medium ${parseFloat(trade.pnl) >= 0 ? 'text-green-500' : 'text-red-500'}">${parseFloat(trade.pnl) >= 0 ? `+${parseFloat(trade.pnl).toFixed(2)}` : parseFloat(trade.pnl).toFixed(2)}</td>
                    <td class="px-6 py-4 max-w-xs truncate">${trade.reason}</td>
                    <td class="px-6 py-4"><button data-id="${trade.id}" class="delete-trade-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
                </tr>
            `).join('');

            if (trades.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500 dark:text-gray-400">Belum ada data trade.</td></tr>`;
            }
            lucide.createIcons(); // Re-render icons
        }

        function renderPlan() {
            views.plan.innerHTML = createPlanHTML();
            const form = document.getElementById('plan-form');
            const currentPlan = plan || {};
            form.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 border-b pb-2">Strategi Utama</h2>
                        <div><label class="block text-sm font-medium">Fokus Pair/Symbol</label><input type="text" name="focusedPairs" value="${currentPlan.focusedPairs || ''}" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Strategi Utama</label><input type="text" name="strategy" value="${currentPlan.strategy || ''}" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Timeframe Utama</label><input type="text" name="timeframe" value="${currentPlan.timeframe || ''}" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 border-b pb-2">Manajemen Risiko</h2>
                        <div><label class="block text-sm font-medium">Risiko per Trade (%)</label><input type="number" name="riskPerTrade" value="${currentPlan.riskPerTrade || 1}" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Target Profit Bulanan ($)</label><input type="number" name="monthlyTarget" value="${currentPlan.monthlyTarget || 2000}" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Maksimal Drawdown (%)</label><input type="number" name="maxDrawdown" value="${currentPlan.maxDrawdown || 10}" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                    </div>
                </div>
                <button type="submit" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg">Simpan Rencana</button>
            `;
            form.addEventListener('submit', handleSavePlan);
        }
        
        function renderCalculator() {
            views.calculator.innerHTML = createCalculatorHTML();
            document.getElementById('calculator-inputs').innerHTML = `
                <div><label class="block text-sm font-medium">Modal Akun ($)</label><input type="number" name="accountBalance" value="10000" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Risiko per Trade (%)</label><input type="number" name="riskPercentage" value="1" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Stop Loss (pips)</label><input type="number" name="stopLossPips" value="20" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Nilai per Pip ($)</label><input type="number" name="pipValue" value="10" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div>
            `;
            document.getElementById('calculator-inputs').addEventListener('input', handleCalculateRisk);
            handleCalculateRisk(); // Initial calculation
        }

        function renderProfile() {
            views.profile.innerHTML = createProfileHTML();
            const form = document.getElementById('profile-form');
            form.querySelector('[name="name"]').value = profile.name || 'Trader';
            form.addEventListener('submit', handleSaveProfile);
        }

        // --- Calculation and Logic Functions ---
        function calculateStats() {
            const totalTrades = trades.length;
            if (totalTrades === 0) return { winRate: 0, totalPnl: 0, averageRiskReward: 0, winTrades: 0, lossTrades: 0 };

            const winTrades = trades.filter(t => t.result === 'win').length;
            const lossTrades = trades.filter(t => t.result === 'loss').length;
            const totalPnl = trades.reduce((acc, t) => acc + (parseFloat(t.pnl) || 0), 0);
            
            const totalRiskReward = trades.reduce((acc, t) => {
                const entry = parseFloat(t.entryPrice), sl = parseFloat(t.stopLoss), tp = parseFloat(t.takeProfit);
                if(entry && sl && tp && sl !== entry) return acc + (Math.abs(tp - entry) / Math.abs(entry - sl));
                return acc;
            }, 0);

            return {
                winRate: (winTrades / totalTrades) * 100,
                totalPnl,
                averageRiskReward: totalTrades > 0 ? totalRiskReward / totalTrades : 0,
                winTrades,
                lossTrades,
            };
        }
        
        function renderCharts(stats) {
            const pnlCtx = document.getElementById('pnlChart')?.getContext('2d');
            const winLossCtx = document.getElementById('winLossChart')?.getContext('2d');

            if (pnlChart) pnlChart.destroy();
            if (winLossChart) winLossChart.destroy();

            if (pnlCtx) {
                pnlChart = new Chart(pnlCtx, {
                    type: 'bar',
                    data: {
                        labels: trades.map((t, i) => `Trade ${i+1}`),
                        datasets: [{
                            label: 'P/L ($)',
                            data: trades.map(t => parseFloat(t.pnl) || 0),
                            backgroundColor: trades.map(t => (parseFloat(t.pnl) || 0) >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }

            if (winLossCtx) {
                winLossChart = new Chart(winLossCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Menang', 'Kalah'],
                        datasets: [{
                            data: [stats.winTrades, stats.lossTrades],
                            backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                        }]
                    }
                });
            }
        }
        
        function handleCalculateRisk() {
            const inputs = document.getElementById('calculator-inputs');
            const resultEl = document.getElementById('calculator-result');
            if (!inputs || !resultEl) return;
            
            const values = {
                accountBalance: parseFloat(inputs.querySelector('[name="accountBalance"]').value),
                riskPercentage: parseFloat(inputs.querySelector('[name="riskPercentage"]').value),
                stopLossPips: parseFloat(inputs.querySelector('[name="stopLossPips"]').value),
                pipValue: parseFloat(inputs.querySelector('[name="pipValue"]').value),
            };

            if (Object.values(values).every(v => v > 0)) {
                const riskAmount = (values.accountBalance * values.riskPercentage) / 100;
                const lotSize = riskAmount / (values.stopLossPips * values.pipValue);
                resultEl.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Hasil Kalkulasi</h2>
                    <div class="text-center space-y-4">
                        <div><h3 class="text-gray-500 dark:text-gray-400">Risiko Uang</h3><p class="text-3xl font-bold text-red-500">$${riskAmount.toFixed(2)}</p></div>
                        <div><h3 class="text-gray-500 dark:text-gray-400">Ukuran Lot Disarankan</h3><p class="text-4xl font-bold text-blue-600">${lotSize.toFixed(2)}</p></div>
                    </div>`;
            } else {
                resultEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Isi semua parameter untuk menghitung.</p>`;
            }
        }

        // --- Event Handlers ---
        function handleNavigation(e) {
            e.preventDefault();
            const navItem = e.target.closest('.nav-item');
            if (!navItem) return;

            const viewName = navItem.dataset.view;
            
            // Update active nav item style
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active-nav'));
            navItem.classList.add('active-nav');
            
            // Show the correct view
            Object.values(views).forEach(view => view.classList.remove('active'));
            views[viewName].classList.add('active');
            
            // Render content for the view
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'journal': renderJournal(); break;
                case 'plan': renderPlan(); break;
                case 'calculator': renderCalculator(); break;
                case 'profile': renderProfile(); break;
            }
            lucide.createIcons();
        }
        
        async function handleAddTrade(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tradeData = Object.fromEntries(formData.entries());
            
            try {
                const tradesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'trades');
                await addDoc(tradesCollectionRef, { ...tradeData, createdAt: serverTimestamp() });
                e.target.reset();
                e.target.classList.add('hidden');
            } catch (error) {
                console.error("Error adding trade:", error);
                alert("Gagal menambahkan trade.");
            }
        }

        async function handleDeleteTrade(e) {
            if (!e.target.closest('.delete-trade-btn')) return;
            const btn = e.target.closest('.delete-trade-btn');
            const tradeId = btn.dataset.id;
            
            if (confirm("Apakah Anda yakin ingin menghapus trade ini?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'trades', tradeId));
                } catch (error) {
                    console.error("Error deleting trade:", error);
                    alert("Gagal menghapus trade.");
                }
            }
        }

        async function handleSavePlan(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const planData = Object.fromEntries(formData.entries());
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'plan', 'mainPlan'), planData, { merge: true });
                alert("Rencana trading berhasil disimpan!");
            } catch (error) {
                console.error("Error saving plan:", error);
                alert("Gagal menyimpan rencana.");
            }
        }
        
        async function handleSaveProfile(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'mainProfile'), profileData, { merge: true });
                alert("Profil berhasil disimpan!");
            } catch (error) {
                console.error("Error saving profile:", error);
                alert("Gagal menyimpan profil.");
            }
        }

        // --- Initialization ---
        function initApp() {
            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const icon = document.documentElement.classList.contains('dark') ? 'sun' : 'moon';
                themeToggle.querySelector('i').setAttribute('data-lucide', icon);
                lucide.createIcons();
            });
            
            // Navigation
            navMenu.addEventListener('click', handleNavigation);

            // Event delegation for delete buttons
            mainContent.addEventListener('click', handleDeleteTrade);
        }

        // --- Firebase Auth and Data Loading ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID: ${userId}`;
                
                // Load all user data
                const tradesRef = collection(db, 'artifacts', appId, 'users', userId, 'trades');
                onSnapshot(query(tradesRef), (snapshot) => {
                    trades = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if (views.dashboard.classList.contains('active')) renderDashboard();
                    if (views.journal.classList.contains('active')) renderJournalTable();
                });

                const planRef = doc(db, 'artifacts', appId, 'users', userId, 'plan', 'mainPlan');
                onSnapshot(planRef, (doc) => {
                    plan = doc.exists() ? doc.data() : { monthlyTarget: 2000 };
                    if (views.dashboard.classList.contains('active')) renderDashboard();
                    if (views.plan.classList.contains('active')) renderPlan();
                });

                const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'mainProfile');
                onSnapshot(profileRef, (doc) => {
                    profile = doc.exists() ? doc.data() : { name: 'Trader' };
                    profileNameDisplay.textContent = profile.name;
                    if (views.profile.classList.contains('active')) renderProfile();
                });

                loadingView.style.display = 'none';
                views.dashboard.classList.add('active');
                renderDashboard();
                lucide.createIcons();

            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        // Initial call to setup event listeners
        initApp();

    </script>
</body>
</html>
