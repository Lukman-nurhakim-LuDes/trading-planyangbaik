<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Plan Pro</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#a78bfa">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for Donut Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-top: 64px; /* Tinggi header */
            padding-bottom: 64px; /* Tinggi footer */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom right, #f0f4f8, #e0e7ff, #f3e8ff); /* Gradien pastel yang lebih lembut */
            color: #374151; /* Warna teks default */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode styles */
        html.dark body {
            background: linear-gradient(to bottom right, #1a202c, #2d3748, #4a5568); /* Darker gradient */
            color: #e2e8f0; /* Light text for dark mode */
        }
        html.dark .bg-white { background-color: #2d3748; }
        html.dark .bg-gray-50 { background-color: #4a5568; }
        html.dark .bg-gray-100 { background-color: #2d3748; }
        html.dark .bg-blue-50 { background-color: #3182ce; } /* Darker blue for cards */
        html.dark .bg-green-50 { background-color: #38a169; } /* Darker green for cards */
        html.dark .bg-red-50 { background-color: #e53e3e; } /* Darker red for cards */
        html.dark .bg-yellow-50 { background-color: #d69e2e; } /* Darker yellow for cards */
        html.dark .text-gray-800 { color: #e2e8f0; }
        html.dark .text-gray-700 { color: #cbd5e0; }
        html.dark .text-gray-600 { color: #a0aec0; }
        html.dark .text-blue-700 { color: #63b3ed; }
        html.dark .text-green-700 { color: #68d391; }
        html.dark .text-red-700 { color: #fc8181; }
        html.dark .text-yellow-700 { color: #f6e05e; }
        html.dark .border-gray-100 { border-color: #4a5568; }
        html.dark .border-gray-200 { border-color: #4a5568; }
        html.dark .border-gray-300 { border-color: #718096; }
        html.dark .border-blue-100 { border-color: #4299e1; }
        html.dark .border-green-100 { border-color: #48bb78; }
        html.dark .border-red-100 { border-color: #f56565; }
        html.dark .border-yellow-100 { border-color: #ecc94b; }
        html.dark .hover\:bg-gray-50:hover { background-color: #6b7280; } /* Darker hover for table rows */
        html.dark .nav-button.active { background-color: #6b21a8; color: #e2e8f0; } /* Dark mode active nav */
        html.dark .nav-button.hover\:bg-purple-100:hover { background-color: #4a0e7d; } /* Dark mode nav hover */
        html.dark .bg-purple-50 { background-color: #4a0e7d; color: #e2e8f0; } /* Darker purple for calculator result */


        #app-container-main { /* Changed ID to avoid conflict with nested div */
            flex-grow: 1;
            padding: 1rem; /* Padding keseluruhan yang lebih kecil */
            overflow-y: auto;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px; /* Padding modal lebih baik */
            border-radius: 12px; /* Sudut lebih membulat */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Bayangan lebih dalam */
            max-width: 400px;
            width: 90%;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        html.dark .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }


        /* Styling untuk tombol navigasi aktif */
        .nav-button.active {
            background-color: #d8b4fe; /* purple-300 */
            color: #6b21a8; /* purple-800 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Styling untuk input dan textarea */
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            padding: 10px 12px; /* Padding input yang lebih baik */
            border-radius: 8px; /* Sudut lebih membulat */
            border: 1px solid #d1d5db; /* Warna border default */
            transition: all 0.2s ease-in-out;
            background-color: #ffffff; /* Ensure white background in light mode */
        }
        html.dark input[type="number"],
        html.dark input[type="date"],
        html.dark select,
        html.dark textarea {
            background-color: #4a5568; /* Darker input background */
            border-color: #718096; /* Darker border */
            color: #e2e8f0; /* Light text */
        }
        html.dark input::placeholder,
        html.dark textarea::placeholder {
            color: #a0aec0; /* Lighter placeholder text */
        }

        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #a78bfa; /* purple-400 */
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3); /* Ring fokus */
        }
        button {
            transition: all 0.2s ease-in-out;
            border-radius: 8px; /* Sudut tombol membulat */
        }
        button:hover {
            transform: translateY(-1px); /* Efek hover ringan */
        }
        .shadow-custom {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Bayangan kustom untuk kartu */
        }
        html.dark .shadow-custom {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* Darker shadow for dark mode */
        }

        /* Progress bar styling */
        progress {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #e0e7ff; /* light blue-purple */
        }
        progress::-webkit-progress-bar {
            background-color: #e0e7ff;
            border-radius: 10px;
        }
        progress::-webkit-progress-value {
            background: linear-gradient(to right, #8b5cf6, #a78bfa); /* purple-500 to purple-400 */
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }
        progress::-moz-progress-bar {
            background: linear-gradient(to right, #8b5cf6, #a78bfa);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <noscript>Anda perlu mengaktifkan JavaScript untuk menjalankan aplikasi ini.</noscript>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-200 to-purple-200 p-4 shadow-lg z-10 rounded-b-xl flex items-center justify-between">
        <div class="w-1/3 flex justify-start">
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors duration-200 shadow-md">
                ‚òÄÔ∏è
            </button>
        </div>
        <h1 class="text-center text-gray-800 font-bold flex-grow" style="font-size: 20px;">Trading Plan Pro</h1>
        <div id="logout-button-container" class="w-1/3 flex justify-end">
            <!-- Logout button will be rendered here by JS if user is logged in -->
        </div>
    </header>

    <!-- Login/Register Section -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 text-gray-800 p-4">
        <div class="bg-white p-8 rounded-xl shadow-custom w-full max-w-md">
            <h2 id="auth-title" class="text-3xl font-bold text-center text-gray-800 mb-8">Login</h2>
            <div class="space-y-6">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="auth-email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="your@example.com">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="auth-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="********">
                </div>
                <p id="auth-error-message" class="text-red-600 text-sm text-center hidden"></p>
                <button id="auth-submit-button" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-200 shadow-md">
                    Login
                </button>
                <button id="auth-toggle-button" class="w-full text-purple-600 py-2 px-6 rounded-lg font-semibold hover:bg-purple-50 transition-all duration-200">
                    Belum punya akun? Daftar di sini.
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="main-app-content" class="hidden flex-grow flex flex-col">
        <div id="app-container-main" class="max-w-4xl mx-auto w-full">
            <!-- Content will be rendered here by JavaScript -->
            <div id="loading-spinner" class="flex items-center justify-center h-64">
                <p class="text-xl font-semibold text-gray-700">Memuat aplikasi...</p>
            </div>
            <div id="dashboard-section" class="hidden"></div>
            <div id="calculator-section" class="hidden"></div>
            <div id="dailyTarget-section" class="hidden"></div>
            <div id="journal-section" class="hidden"></div>
            <div id="calendar-section" class="hidden"></div>
            <div id="strategy-section" class="hidden"></div> <!-- New Strategy Section -->
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-200 to-purple-200 p-2 shadow-xl z-10 flex justify-around items-center rounded-t-xl">
            <button id="nav-dashboard" class="nav-button flex flex-col items-center p-2 rounded-lg transition-colors duration-200 text-gray-700 hover:bg-purple-100">
                <span class="text-2xl">üìä</span>
                <span class="text-xs font-medium mt-1">Dashboard</span>
            </button>
            <button id="nav-calculator" class="nav-button flex flex-col items-center p-2 rounded-lg transition-colors duration-200 text-gray-700 hover:bg-purple-100">
                <span class="text-2xl">‚ûï</span>
                <span class="text-xs font-medium mt-1">Kalkulator</span>
            </button>
            <button id="nav-dailyTarget" class="nav-button flex flex-col items-center p-2 rounded-lg transition-colors duration-200 text-gray-700 hover:bg-purple-100">
                <span class="text-2xl">üéØ</span>
                <span class="text-xs font-medium mt-1">Target Harian</span>
            </button>
            <button id="nav-journal" class="nav-button flex flex-col items-center p-2 rounded-lg transition-colors duration-200 text-gray-700 hover:bg-purple-100">
                <span class="text-2xl">üìù</span>
                <span class="text-xs font-medium mt-1">Jurnal</span>
            </button>
            <button id="nav-strategy" class="nav-button flex flex-col items-center p-2 rounded-lg transition-colors duration-200 text-gray-700 hover:bg-purple-100">
                <span class="text-2xl">üí°</span>
                <span class="text-xs font-medium mt-1">Strategi</span>
            </button>
            <button id="nav-calendar" class="nav-button flex flex-col items-center p-2 rounded-lg transition-colors duration-200 text-gray-700 hover:bg-purple-100">
                <span class="text-2xl">üóìÔ∏è</span>
                <span class="text-xs font-medium mt-1">Kalender</span>
            </button>
        </nav>
    </div>

    <!-- Custom Notification Modal -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-green-600 mb-4">üéâ Selamat! üéâ</h3>
            <p id="notification-message" class="text-lg text-gray-800 mb-6"></p>
            <button id="modal-close-button" class="bg-green-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-200 shadow-md">
                Oke
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Ensure global variables are available or use defaults
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAPKJfQpYiZkFoIdvZaI2cAQ-Z50mu_gM8",
            authDomain: "trading-plan-416fb.firebaseapp.com",
            projectId: "trading-plan-416fb",
            storageBucket: "trading-plan-416fb.firebasestorage.app",
            messagingSenderId: "140608805879",
            appId: "1:140608805879:web:6ce3def86c9689c2786cf2",
            measurementId: "G-5EGLDF7228"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Helper untuk format mata uang Rupiah
        const formatRupiah = (amount) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
        };

        // Fungsi untuk konversi tanggal ke format YYYY-MM-DD
        const formatDate = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Application State
        let saldo = 0;
        let profit = 0;
        let loss = 0;
        let monthlyTarget = 0;
        let journalEntries = [];
        let activeTab = 'dashboard';
        let dailyRecords = {}; // Stores { date: { target: amount, profitLoss: amount } }
        let strategies = []; // New state variable for strategies

        // Chart.js instance for donut chart
        let donutChart = null;

        // Custom Modal Functions
        const showNotificationModal = (message) => {
            document.getElementById('notification-message').innerText = message;
            document.getElementById('notification-modal').style.display = 'flex';
        };

        const hideNotificationModal = () => {
            document.getElementById('notification-modal').style.display = 'none';
        };

        // --- UI Rendering Functions ---

        const renderDashboard = () => {
            const dashboardSection = document.getElementById('dashboard-section');
            dashboardSection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-blue-50 p-5 rounded-lg shadow-sm flex flex-col items-center border border-blue-100">
                            <span class="text-sm text-gray-600 font-medium">Saldo Saat Ini</span>
                            <span class="text-3xl font-extrabold text-blue-700 mt-1">${formatRupiah(saldo)}</span>
                        </div>
                        <div class="bg-green-50 p-5 rounded-lg shadow-sm flex flex-col items-center border border-green-100">
                            <span class="text-sm text-gray-600 font-medium">Total Profit</span>
                            <span class="text-3xl font-extrabold text-green-700 mt-1">${formatRupiah(profit)}</span>
                        </div>
                        <div class="bg-red-50 p-5 rounded-lg shadow-sm flex flex-col items-center border border-red-100">
                            <span class="text-sm text-gray-600 font-medium">Total Loss</span>
                            <span class="text-3xl font-extrabold text-red-700 mt-1">${formatRupiah(loss)}</span>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Tambah Saldo Modal</h3>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="number" id="addSaldoInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Contoh: 1.000.000">
                            <button id="addSaldoButton" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-md">
                                Tambah Saldo
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribusi Profit/Loss</h3>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm h-72 flex items-center justify-center border border-gray-100">
                        <canvas id="profitLossDonutChart"></canvas>
                    </div>
                </div>
            `;

            // Add event listener for adding saldo
            document.getElementById('addSaldoButton').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('addSaldoInput').value);
                if (!isNaN(amount) && amount > 0) {
                    saldo += amount;
                    updateUserSummary(); // Update user summary in Firestore
                    document.getElementById('addSaldoInput').value = ''; // Clear input
                    showNotificationModal(`${formatRupiah(amount)} telah ditambahkan ke saldo Anda.`);
                } else {
                    showNotificationModal('Mohon masukkan jumlah saldo yang valid dan positif.');
                }
            });

            // Render Donut Chart
            const ctx = document.getElementById('profitLossDonutChart').getContext('2d');
            if (donutChart) {
                donutChart.destroy(); // Destroy previous chart instance if exists
            }

            const data = {
                labels: ['Total Profit', 'Total Loss'],
                datasets: [{
                    data: [profit, loss],
                    backgroundColor: ['#34D399', '#EF4444'], // Green-400, Red-500
                    hoverOffset: 8
                }]
            };

            donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14,
                                    family: 'Inter'
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color-primary') || '#374151', // Dynamic text color
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map(function(label, i) {
                                            const meta = chart.getDatasetMeta(0);
                                            const ds = data.datasets[0];
                                            const value = ds.data[i];
                                            const total = ds.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0%';
                                            return {
                                                text: `${label}: ${formatRupiah(value)} (${percentage})`,
                                                fillStyle: ds.backgroundColor[i],
                                                strokeStyle: ds.borderColor ? ds.borderColor[i] : ds.backgroundColor[i],
                                                lineWidth: 1,
                                                hidden: isNaN(ds.data[i]) || meta.data[i].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0%';
                                    return `${label}: ${formatRupiah(value)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        };

        const renderTradingCalculator = () => {
            const calculatorSection = document.getElementById('calculator-section');
            calculatorSection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Kalkulator Trading</h2>
                    <div class="space-y-5">
                        <div>
                            <label for="entryPrice" class="block text-sm font-medium text-gray-700 mb-2">Harga Masuk (Rp)</label>
                            <input type="number" id="entryPrice" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Contoh: 1000">
                        </div>
                        <div>
                            <label for="exitPrice" class="block text-sm font-medium text-gray-700 mb-2">Harga Keluar (Rp)</label>
                            <input type="number" id="exitPrice" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Contoh: 1100">
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">Kuantitas</label>
                            <input type="number" id="quantity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Contoh: 100">
                        </div>
                        <button id="calculate-button" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-200 shadow-md">
                            Hitung Profit/Loss
                        </button>
                        <div id="calculator-result" class="mt-4 p-4 bg-purple-50 text-purple-700 rounded-lg font-medium text-center hidden"></div>
                    </div>
                </div>
            `;

            document.getElementById('calculate-button').addEventListener('click', () => {
                const entryPrice = parseFloat(document.getElementById('entryPrice').value);
                const exitPrice = parseFloat(document.getElementById('exitPrice').value);
                const quantity = parseFloat(document.getElementById('quantity').value);
                const resultDiv = document.getElementById('calculator-result');

                if (isNaN(entryPrice) || isNaN(exitPrice) || isNaN(quantity) || quantity <= 0) {
                    resultDiv.innerText = 'Mohon masukkan angka yang valid.';
                    resultDiv.classList.remove('hidden');
                    return;
                }

                const pl = (exitPrice - entryPrice) * quantity;
                resultDiv.innerText = `Profit/Loss: ${formatRupiah(pl)}`;
                resultDiv.classList.remove('hidden');
            });
        };

        const renderDailyTargetScorecard = () => {
            const dailyTargetSection = document.getElementById('dailyTarget-section');
            const today = formatDate(new Date());
            const currentDayRecord = dailyRecords[today] || { target: 0, profitLoss: 0 };

            // Calculate current month's profit/loss
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let currentMonthProfitLoss = 0;
            for (const date in dailyRecords) {
                const recordDate = new Date(date);
                if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                    currentMonthProfitLoss += dailyRecords[date].profitLoss || 0;
                }
            }

            const monthlyProgress = monthlyTarget > 0 ? (currentMonthProfitLoss / monthlyTarget) * 100 : 0;
            const progressBarValue = Math.max(0, Math.min(100, monthlyProgress)); // Ensure value is between 0 and 100

            dailyTargetSection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Kartu Skor Target Harian & Bulanan</h2>
                    
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Set Target Harian</h3>
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <input type="date" id="targetDateInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" value="${today}">
                            <input type="number" id="dailyTargetInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Target Rp" value="${currentDayRecord.target}">
                            <button id="setDailyTargetButton" class="bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-200 shadow-md">
                                Set Target
                            </button>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg shadow-sm text-center border border-yellow-100">
                            <span class="text-sm text-gray-600 font-medium">Target Harian untuk ${today}:</span>
                            <span class="block text-2xl font-bold text-yellow-700 mt-1">${formatRupiah(currentDayRecord.target)}</span>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Progres Target Bulanan</h3>
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <input type="number" id="monthlyTargetInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Target Bulanan Rp" value="${monthlyTarget}">
                            <button id="setMonthlyTargetButton" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-md">
                                Set Bulanan
                            </button>
                        </div>
                        <div class="mb-4 text-center">
                            <span class="text-sm text-gray-600 font-medium">Target Bulanan: ${formatRupiah(monthlyTarget)}</span><br>
                            <span class="text-lg font-bold text-purple-700">Progres: ${formatRupiah(currentMonthProfitLoss)}</span>
                        </div>
                        <progress value="${progressBarValue}" max="100"></progress>
                        <div class="text-center text-sm text-gray-600 mt-2">${progressBarValue.toFixed(2)}% Tercapai</div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Skor Harian</h3>
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <input type="number" id="addScoreInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Tambah Profit/Loss Rp">
                            <button id="addScoreButton" class="bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-all duration-200 shadow-md">
                                Tambah Skor
                            </button>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg shadow-sm text-center border border-green-100">
                            <span class="text-sm text-gray-600 font-medium">Profit/Loss Hari Ini:</span>
                            <span class="block text-3xl font-extrabold text-green-700 mt-1">${formatRupiah(currentDayRecord.profitLoss)}</span>
                        </div>
                        <button id="resetScoreButton" class="w-full bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-200 shadow-md mt-4">
                            Reset Skor Harian
                        </button>
                    </div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Target & Progres Harian Sebelumnya</h3>
                    <div id="daily-records-table" class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <!-- Daily records table will be rendered here -->
                    </div>
                </div>
            `;

            // Event Listeners
            document.getElementById('setDailyTargetButton').addEventListener('click', () => {
                const targetDate = document.getElementById('targetDateInput').value;
                const newTarget = parseFloat(document.getElementById('dailyTargetInput').value);
                if (!isNaN(newTarget) && newTarget >= 0) {
                    updateDailyRecord(targetDate, newTarget, dailyRecords[targetDate]?.profitLoss || 0);
                    showNotificationModal(`Target harian untuk ${targetDate} disetel ke ${formatRupiah(newTarget)}.`);
                } else {
                    showNotificationModal('Mohon masukkan target harian yang valid dan positif.');
                }
            });

            document.getElementById('setMonthlyTargetButton').addEventListener('click', () => {
                const newMonthlyTarget = parseFloat(document.getElementById('monthlyTargetInput').value);
                if (!isNaN(newMonthlyTarget) && newMonthlyTarget >= 0) {
                    monthlyTarget = newMonthlyTarget;
                    updateUserSummary();
                    showNotificationModal(`Target bulanan disetel ke ${formatRupiah(newMonthlyTarget)}.`);
                } else {
                    showNotificationModal('Mohon masukkan target bulanan yang valid dan positif.');
                }
            });

            document.getElementById('addScoreInput').addEventListener('change', (event) => {
                // This input is now mainly for manual adjustment, journal entries update profitLoss automatically
                // However, if user wants to manually add to current day's PL, this is where
                const scoreToAdd = parseFloat(event.target.value);
                if (!isNaN(scoreToAdd)) {
                    const currentPL = dailyRecords[today]?.profitLoss || 0;
                    updateDailyRecord(today, dailyRecords[today]?.target || 0, currentPL + scoreToAdd);
                    event.target.value = ''; // Clear input
                    showNotificationModal(`Profit/Loss hari ini diperbarui.`);
                } else {
                    showNotificationModal('Skor yang dimasukkan harus angka.');
                }
            });

            document.getElementById('resetScoreButton').addEventListener('click', () => {
                updateDailyRecord(today, dailyRecords[today]?.target || 0, 0);
                showNotificationModal('Skor harian direset.');
            });

            // Update daily records table
            const updateDailyRecordsTable = () => {
                const dailyRecordsTable = document.getElementById('daily-records-table');
                const sortedDailyRecords = Object.entries(dailyRecords)
                    .sort(([dateA], [dateB]) => new Date(b.date) - new Date(a.date)); // Sort descending by date

                if (sortedDailyRecords.length === 0) {
                    dailyRecordsTable.innerHTML = '<p class="text-center text-gray-600 p-6">Belum ada catatan harian.</p>';
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Target</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Profit/Loss Harian</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                `;
                sortedDailyRecords.forEach(([date, record]) => {
                    const status = (record.profitLoss || 0) >= (record.target || 0) && (record.target || 0) > 0 ? 'Tercapai' : 'Belum Tercapai';
                    const statusClass = status === 'Tercapai' ? 'text-green-600 font-semibold' : 'text-red-600';
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${date}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.target || 0)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.profitLoss || 0)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm ${statusClass}">${status}</td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                dailyRecordsTable.innerHTML = tableHtml;
            };
            updateDailyRecordsTable();
        };

        const renderTradingJournal = () => {
            const journalSection = document.getElementById('journal-section');
            journalSection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Jurnal Trading</h2>

                    <div class="space-y-5 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-xl font-semibold text-gray-800">Tambah Entri Baru</h3>
                        <div>
                            <label for="journalDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="journalDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" value="${formatDate(new Date())}">
                        </div>
                        <div>
                            <label for="journalType" class="block text-sm font-medium text-gray-700 mb-2">Tipe</label>
                            <select id="journalType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300">
                                <option value="profit">Profit</option>
                                <option value="loss">Loss</option>
                            </select>
                        </div>
                        <div>
                            <label for="journalAmount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                            <input type="number" id="journalAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Contoh: 50000">
                        </div>
                        <div>
                            <label for="journalNotes" class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                            <textarea id="journalNotes" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" rows="3" placeholder="Catatan trading Anda..."></textarea>
                        </div>
                        <button id="addEntryButton" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-200 shadow-md">
                            Tambah Entri
                        </button>
                    </div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Filter & Ekspor Jurnal</h3>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8 border border-gray-100 space-y-4">
                        <div>
                            <label for="filterDate" class="block text-sm font-medium text-gray-700 mb-2">Filter Tanggal</label>
                            <input type="date" id="filterDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium text-gray-700 mb-2">Filter Tipe</label>
                            <select id="filterType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300">
                                <option value="">Semua</option>
                                <option value="profit">Profit</option>
                                <option value="loss">Loss</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchText" class="block text-sm font-medium text-gray-700 mb-2">Cari Catatan</label>
                            <input type="text" id="searchText" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Cari di catatan...">
                        </div>
                        <button id="applyFilterButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-md">
                            Terapkan Filter
                        </button>
                        <button id="resetFilterButton" class="w-full bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-200 shadow-md">
                            Reset Filter
                        </button>
                        <button id="exportJournalButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-all duration-200 shadow-md">
                            Ekspor ke CSV
                        </button>
                    </div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Daftar Entri</h3>
                    <div id="journal-entries-list" class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <!-- Journal entries table will be rendered here -->
                    </div>
                </div>
            `;

            const updateJournalTable = (filteredEntries = journalEntries) => {
                const journalEntriesList = document.getElementById('journal-entries-list');
                if (filteredEntries.length === 0) {
                    journalEntriesList.innerHTML = '<p class="text-center text-gray-600 p-6">Belum ada entri jurnal yang sesuai filter.</p>';
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipe</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Catatan</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                `;
                filteredEntries.forEach(entry => {
                    const typeClass = entry.type === 'profit' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    tableHtml += `
                        <tr data-id="${entry.id}" class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${entry.date}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                                    ${entry.type === 'profit' ? 'Profit' : 'Loss'}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(entry.amount)}</td>
                            <td class="px-4 py-3 text-sm text-gray-800 max-w-xs overflow-hidden text-ellipsis">${entry.notes}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                <button class="text-red-600 hover:text-red-800 transition-colors duration-200 delete-entry-button" data-id="${entry.id}">
                                    Hapus
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                journalEntriesList.innerHTML = tableHtml;

                // Attach delete event listeners
                document.querySelectorAll('.delete-entry-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.target.dataset.id;
                        deleteJournalEntry(id);
                    });
                });
            };

            updateJournalTable(); // Initial render

            // Filter and Search Logic
            document.getElementById('applyFilterButton').addEventListener('click', () => {
                const filterDate = document.getElementById('filterDate').value;
                const filterType = document.getElementById('filterType').value;
                const searchText = document.getElementById('searchText').value.toLowerCase();

                const filtered = journalEntries.filter(entry => {
                    const dateMatch = filterDate ? entry.date === filterDate : true;
                    const typeMatch = filterType ? entry.type === filterType : true;
                    const textMatch = searchText ? entry.notes.toLowerCase().includes(searchText) : true;
                    return dateMatch && typeMatch && textMatch;
                });
                updateJournalTable(filtered);
            });

            document.getElementById('resetFilterButton').addEventListener('click', () => {
                document.getElementById('filterDate').value = '';
                document.getElementById('filterType').value = '';
                document.getElementById('searchText').value = '';
                updateJournalTable(journalEntries); // Show all entries
            });

            // Export to CSV Logic
            document.getElementById('exportJournalButton').addEventListener('click', () => {
                if (journalEntries.length === 0) {
                    showNotificationModal('Tidak ada data jurnal untuk diekspor.');
                    return;
                }

                const headers = ["Tanggal", "Tipe", "Jumlah", "Catatan"];
                const rows = journalEntries.map(entry => [
                    `"${entry.date}"`,
                    `"${entry.type === 'profit' ? 'Profit' : 'Loss'}"`,
                    `"${entry.amount}"`,
                    `"${entry.notes.replace(/"/g, '""')}"` // Escape double quotes
                ]);

                let csvContent = "data:text/csv;charset=utf-8," 
                               + headers.join(",") + "\n" 
                               + rows.map(e => e.join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "jurnal_trading.csv");
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link); // Clean up
            });

            document.getElementById('addEntryButton').addEventListener('click', async () => {
                const date = document.getElementById('journalDate').value;
                const type = document.getElementById('journalType').value;
                const amount = parseFloat(document.getElementById('journalAmount').value);
                const notes = document.getElementById('journalNotes').value;

                if (!date || isNaN(amount)) {
                    showNotificationModal('Tanggal dan jumlah harus diisi dengan benar.');
                    return;
                }
                await addJournalEntry({ date, type, amount, notes });
                document.getElementById('journalAmount').value = '';
                document.getElementById('journalNotes').value = '';
                // The onSnapshot listener will re-render the table
            });
        };

        const renderEconomicCalendar = () => {
            const calendarSection = document.getElementById('calendar-section');
            const economicEvents = [
                { date: '2025-08-01', time: '08:00 WIB', event: 'Pengumuman Inflasi Indonesia', impact: 'Tinggi' },
                { date: '2025-08-05', time: '14:30 WIB', event: 'Data Manufaktur PMI AS', impact: 'Sedang' },
                { date: '2025-08-10', time: '10:00 WIB', event: 'Keputusan Suku Bunga Bank Sentral Eropa', impact: 'Tinggi' },
                { date: '2025-08-15', time: '19:00 WIB', event: 'Penjualan Ritel Inggris', impact: 'Rendah' },
                { date: '2025-08-20', time: '11:00 WIB', event: 'Laporan Ketenagakerjaan Jepang', impact: 'Sedang' },
            ];

            let eventsHtml = '';
            if (economicEvents.length === 0) {
                eventsHtml = '<p class="text-center text-gray-600">Tidak ada event ekonomi yang akan datang.</p>';
            } else {
                economicEvents.forEach((event, index) => {
                    eventsHtml += `
                        <div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-100 flex items-center space-x-4">
                            <div class="text-center">
                                <p class="text-lg font-bold text-blue-800">${event.date.substring(8,10)}</p>
                                <p class="text-xs text-gray-600">${new Date(event.date).toLocaleString('id-ID', { month: 'short' })}</p>
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm font-semibold text-blue-800">${event.time}</p>
                                <p class="text-md text-gray-800">${event.event}</p>
                                <p class="text-xs text-gray-600">Dampak: <span class="font-medium">${event.impact}</span></p>
                            </div>
                        </div>
                    `;
                });
            }

            calendarSection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Kalender Ekonomi</h2>
                    <div class="bg-red-50 p-5 rounded-lg shadow-sm border border-red-200 mb-8">
                        <p class="text-sm text-red-700 font-semibold mb-3">
                            **PENTING: Mengambil data langsung dari Investing.com (atau situs serupa) dari browser akan menghadapi masalah CORS (Cross-Origin Resource Sharing).**
                            Ini berarti browser memblokir permintaan ke domain lain untuk alasan keamanan.
                        </p>
                        <p class="text-sm text-red-700 mb-3">
                            Untuk mendapatkan data kalender ekonomi real-time dari Investing.com (atau sumber eksternal lainnya), Anda biasanya memerlukan salah satu solusi berikut:
                        </p>
                        <ul class="list-disc list-inside text-sm text-red-700 ml-4 space-y-1">
                            <li>**Menggunakan API Resmi:** Jika Investing.com atau penyedia data finansial lainnya menawarkan API resmi (Application Programming Interface), ini adalah cara terbaik. Anda akan mendaftar untuk mendapatkan kunci API dan menggunakannya untuk mengambil data secara terstruktur. API ini biasanya sudah dikonfigurasi untuk mengatasi masalah CORS.</li>
                            <li>**Server Proxy (Backend):** Anda dapat membuat server backend sederhana (misalnya, menggunakan Node.js, Python, PHP) yang bertindak sebagai "perantara". Server ini akan membuat permintaan ke Investing.com (dari sisi server, CORS tidak berlaku) dan kemudian meneruskan data tersebut ke aplikasi frontend Anda. Ini adalah solusi umum jika tidak ada API resmi.</li>
                        </ul>
                        <p class="text-sm text-red-700 mt-3">
                            Karena kendala keamanan browser dan lingkungan Canvas, aplikasi ini tidak dapat secara langsung mengambil data dari Investing.com. Data di bawah ini adalah **simulasi**.
                        </p>
                    </div>
                    <div class="space-y-4">
                        ${eventsHtml}
                    </div>
                </div>
            `;
        };

        const renderStrategy = () => {
            const strategySection = document.getElementById('strategy-section');
            strategySection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-custom mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Manajemen Strategi Trading</h2>

                    <div class="space-y-5 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 id="strategy-form-title" class="text-xl font-semibold text-gray-800">Tambah Strategi Baru</h3>
                        <div>
                            <label for="strategyName" class="block text-sm font-medium text-gray-700 mb-2">Nama Strategi</label>
                            <input type="text" id="strategyName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" placeholder="Contoh: Scalping Sederhana">
                        </div>
                        <div>
                            <label for="strategyDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi & Aturan</label>
                            <textarea id="strategyDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-300 focus:border-purple-300" rows="5" placeholder="Jelaskan aturan masuk, keluar, manajemen risiko..."></textarea>
                        </div>
                        <button id="saveStrategyButton" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-200 shadow-md">
                            Tambah Strategi
                        </button>
                        <button id="cancelEditStrategyButton" class="w-full bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-200 shadow-md hidden">
                            Batal Edit
                        </button>
                    </div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Daftar Strategi Anda</h3>
                    <div id="strategies-list" class="space-y-4">
                        <!-- Strategies will be rendered here -->
                    </div>
                </div>
            `;

            // Internal state for editing
            let editingStrategyId = null;

            const updateStrategiesList = () => {
                const strategiesListDiv = document.getElementById('strategies-list');
                if (strategies.length === 0) {
                    strategiesListDiv.innerHTML = '<p class="text-center text-gray-600 p-6">Belum ada strategi yang ditambahkan.</p>';
                    return;
                }

                let strategiesHtml = '';
                strategies.forEach(strategy => {
                    strategiesHtml += `
                        <div class="bg-gray-50 p-5 rounded-lg shadow-sm border border-gray-100">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">${strategy.name}</h4>
                            <p class="text-sm text-gray-700 mb-4 whitespace-pre-wrap">${strategy.description}</p>
                            <div class="flex justify-end space-x-2">
                                <button class="bg-blue-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-600 transition-colors duration-200 edit-strategy-button" data-id="${strategy.id}">
                                    Edit
                                </button>
                                <button class="bg-red-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-600 transition-colors duration-200 delete-strategy-button" data-id="${strategy.id}">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    `;
                });
                strategiesListDiv.innerHTML = strategiesHtml;

                // Attach event listeners for edit and delete buttons
                document.querySelectorAll('.edit-strategy-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.target.dataset.id;
                        const strategyToEdit = strategies.find(s => s.id === id);
                        if (strategyToEdit) {
                            document.getElementById('strategyName').value = strategyToEdit.name;
                            document.getElementById('strategyDescription').value = strategyToEdit.description;
                            document.getElementById('saveStrategyButton').innerText = 'Simpan Perubahan';
                            document.getElementById('strategy-form-title').innerText = 'Edit Strategi';
                            document.getElementById('cancelEditStrategyButton').classList.remove('hidden');
                            editingStrategyId = id;
                        }
                    });
                });

                document.querySelectorAll('.delete-strategy-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.target.dataset.id;
                        deleteStrategy(id);
                    });
                });
            };

            updateStrategiesList(); // Initial render of the list

            document.getElementById('saveStrategyButton').addEventListener('click', async () => {
                const name = document.getElementById('strategyName').value;
                const description = document.getElementById('strategyDescription').value;

                if (!name || !description) {
                    showNotificationModal('Nama dan deskripsi strategi tidak boleh kosong.');
                    return;
                }

                if (editingStrategyId) {
                    await editStrategy(editingStrategyId, name, description);
                    showNotificationModal('Strategi berhasil diperbarui!');
                } else {
                    await addStrategy(name, description);
                    showNotificationModal('Strategi baru berhasil ditambahkan!');
                }

                // Reset form and UI
                document.getElementById('strategyName').value = '';
                document.getElementById('strategyDescription').value = '';
                document.getElementById('saveStrategyButton').innerText = 'Tambah Strategi';
                document.getElementById('strategy-form-title').innerText = 'Tambah Strategi Baru';
                document.getElementById('cancelEditStrategyButton').classList.add('hidden');
                editingStrategyId = null;
            });

            document.getElementById('cancelEditStrategyButton').addEventListener('click', () => {
                document.getElementById('strategyName').value = '';
                document.getElementById('strategyDescription').value = '';
                document.getElementById('saveStrategyButton').innerText = 'Tambah Strategi';
                document.getElementById('strategy-form-title').innerText = 'Tambah Strategi Baru';
                document.getElementById('cancelEditStrategyButton').classList.add('hidden');
                editingStrategyId = null;
            });
        };

        // --- Firebase & Data Logic ---

        // Function to update the main user summary data (saldo, profit, loss, monthlyTarget, dailyRecords)
        const updateUserSummary = async () => {
            if (!db || !userId) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_data');
            try {
                await setDoc(userDocRef, {
                    saldo: saldo,
                    profit: profit,
                    loss: loss,
                    monthlyTarget: monthlyTarget,
                    dailyRecords: dailyRecords // Save the entire dailyRecords map
                }, { merge: true });
            } catch (e) {
                console.error("Error updating user data:", e);
            }
        };

        // Function to update a specific daily record
        const updateDailyRecord = async (date, target, profitLoss) => {
            if (!db || !userId) return;
            dailyRecords = {
                ...dailyRecords,
                [date]: {
                    target: target,
                    profitLoss: profitLoss
                }
            };
            await updateUserSummary(); // Save the updated dailyRecords map to Firestore
        };

        const addJournalEntry = async (entry) => {
            if (!db || !userId) return;
            try {
                const journalCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'journal_entries');
                const newDocRef = doc(journalCollectionRef); // Get a new document reference with an auto-generated ID
                await setDoc(newDocRef, entry);

                // Update local state and derived values
                if (entry.type === 'profit') {
                    saldo += entry.amount;
                    profit += entry.amount;
                } else {
                    saldo -= entry.amount;
                    loss += entry.amount;
                }

                // Update daily profit/loss for the entry's date
                const entryDate = entry.date;
                const currentDailyPL = dailyRecords[entryDate]?.profitLoss || 0;
                const newDailyPL = entry.type === 'profit' ? currentDailyPL + entry.amount : currentDailyPL - entry.amount;
                
                // Ensure daily target exists, if not, initialize it to 0
                const currentDailyTarget = dailyRecords[entryDate]?.target || 0;

                await updateDailyRecord(entryDate, currentDailyTarget, newDailyPL); // Update daily record
                await updateUserSummary(); // Persist changes to Firestore
                // onSnapshot will handle re-rendering the journal table and daily target scorecard
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        const deleteJournalEntry = async (id) => {
            if (!db || !userId) return;
            try {
                const journalEntryRef = doc(db, 'artifacts', appId, 'users', userId, 'journal_entries', id);
                const entryToDelete = journalEntries.find(entry => entry.id === id);

                if (entryToDelete) {
                    // Revert saldo, profit, loss before deleting
                    if (entryToDelete.type === 'profit') {
                        saldo -= entryToDelete.amount;
                        profit -= entryToDelete.amount;
                    } else {
                        saldo += entryToDelete.amount;
                        loss -= entryToDelete.amount;
                    }

                    // Revert daily profit/loss for the entry's date
                    const entryDate = entryToDelete.date;
                    const currentDailyPL = dailyRecords[entryDate]?.profitLoss || 0;
                    const newDailyPL = entryToDelete.type === 'profit' ? currentDailyPL - entryToDelete.amount : currentDailyPL + entryToDelete.amount;
                    
                    const currentDailyTarget = dailyRecords[entryDate]?.target || 0;
                    await updateDailyRecord(entryDate, currentDailyTarget, newDailyPL); // Update daily record
                }
                await deleteDoc(journalEntryRef);
                await updateUserSummary(); // Persist changes to Firestore
                // onSnapshot will handle re-rendering the journal table and daily target scorecard
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };

        // New Firestore functions for strategies
        const addStrategy = async (name, description) => {
            if (!db || !userId) return;
            try {
                // FIX: Corrected Firestore collection path for strategies
                const strategiesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'strategies');
                await setDoc(doc(strategiesCollectionRef), { name, description });
            } catch (e) {
                console.error("Error adding strategy: ", e);
            }
        };

        const editStrategy = async (id, name, description) => {
            if (!db || !userId) return;
            try {
                // FIX: Corrected Firestore collection path for strategies
                const strategyDocRef = doc(db, 'artifacts', appId, 'users', userId, 'strategies', id);
                await setDoc(strategyDocRef, { name, description }, { merge: true });
            } catch (e) {
                console.error("Error updating strategy: ", e);
            }
        };

        const deleteStrategy = async (id) => {
            if (!db || !userId) return;
            try {
                // FIX: Corrected Firestore collection path for strategies
                const strategyDocRef = doc(db, 'artifacts', appId, 'users', userId, 'strategies', id);
                await deleteDoc(strategyDocRef);
            } catch (e) {
                console.error("Error deleting strategy: ", e);
            }
        };

        // Centralized function to set up Firestore listeners after successful authentication
        const setupFirestoreListeners = () => {
            if (!db || !userId) {
                console.warn("Firestore listeners cannot be set up: DB or userId is missing.");
                return;
            }

            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_data');
            const journalCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'journal_entries');
            const strategiesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'strategies'); // New collection reference

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    saldo = data.saldo || 0;
                    profit = data.profit || 0;
                    loss = data.loss || 0;
                    monthlyTarget = data.monthlyTarget || 0;
                    dailyRecords = data.dailyRecords || {}; // Load daily records map
                } else {
                    setDoc(userDocRef, {
                        saldo: 0,
                        profit: 0,
                        loss: 0,
                        monthlyTarget: 0,
                        dailyRecords: {}
                    }, { merge: true }).catch(console.error);
                }
                showSection(activeTab + '-section');
            }, (error) => {
                console.error("Error listening to user data:", error);
            });

            onSnapshot(journalCollectionRef, (snapshot) => {
                const entries = [];
                snapshot.forEach(doc => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                journalEntries = entries;
                if (activeTab === 'journal' || activeTab === 'dashboard' || activeTab === 'dailyTarget') {
                    showSection(activeTab + '-section');
                }
            }, (error) => {
                console.error("Error listening to journal entries:", error);
            });

            // New listener for strategies
            onSnapshot(strategiesCollectionRef, (snapshot) => {
                const loadedStrategies = [];
                snapshot.forEach(doc => {
                    loadedStrategies.push({ id: doc.id, ...doc.data() });
                });
                strategies = loadedStrategies; // Update the global strategies array
                if (activeTab === 'strategy') { // Only re-render if on the strategy tab
                    showSection('strategy-section');
                }
            }, (error) => {
                console.error("Error listening to strategies:", error);
            });
        };

        const showSection = (sectionId) => {
            const sections = ['dashboard-section', 'calculator-section', 'dailyTarget-section', 'journal-section', 'calendar-section', 'strategy-section'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active navigation button style
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`nav-${sectionId.replace('-section', '')}`).classList.add('active');

            // Render content for the active section
            switch (sectionId) {
                case 'dashboard-section':
                    renderDashboard();
                    break;
                case 'calculator-section':
                    renderTradingCalculator();
                    break;
                case 'dailyTarget-section':
                    renderDailyTargetScorecard();
                    break;
                case 'journal-section':
                    renderTradingJournal();
                    break;
                case 'calendar-section':
                    renderEconomicCalendar();
                    break;
                case 'strategy-section': // New case for strategy section
                    renderStrategy();
                    break;
            }
        };

        // Auth state
        let isLoginMode = true; // true for login, false for register

        // Get auth elements
        const authSection = document.getElementById('auth-section');
        const mainAppContent = document.getElementById('main-app-content');
        const authTitle = document.getElementById('auth-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authErrorMessage = document.getElementById('auth-error-message');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authToggleButton = document.getElementById('auth-toggle-button');
        const logoutButtonContainer = document.getElementById('logout-button-container');
        const themeToggleButton = document.getElementById('theme-toggle');


        // Function to update auth UI
        const updateAuthUI = () => {
            authTitle.innerText = isLoginMode ? 'Login' : 'Daftar';
            authSubmitButton.innerText = isLoginMode ? 'Login' : 'Daftar';
            authToggleButton.innerText = isLoginMode ? 'Belum punya akun? Daftar di sini.' : 'Sudah punya akun? Login di sini.';
            authErrorMessage.classList.add('hidden'); // Clear previous errors
        };

        // Handle auth submit
        authSubmitButton.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authErrorMessage.classList.add('hidden'); // Hide previous errors
            authSubmitButton.disabled = true; // Disable button during processing

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                // onAuthStateChanged will handle UI update on success
            } catch (error) {
                let message = 'Terjadi kesalahan. Silakan coba lagi.';
                if (error.code === 'auth/weak-password') {
                    message = 'Kata sandi terlalu lemah. Minimal 6 karakter.';
                } else if (error.code === 'auth/email-already-in-use') {
                    message = 'Email ini sudah terdaftar.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = 'Email atau kata sandi salah.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Format email tidak valid.';
                }
                authErrorMessage.innerText = message;
                authErrorMessage.classList.remove('hidden');
                console.error("Auth error:", error);
            } finally {
                authSubmitButton.disabled = false; // Re-enable button
            }
        });

        // Handle auth toggle
        authToggleButton.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            updateAuthUI();
        });

        // Theme toggle logic
        const toggleTheme = () => {
            const htmlElement = document.documentElement;
            if (htmlElement.classList.contains('dark')) {
                htmlElement.classList.remove('dark');
                themeToggleButton.innerText = '‚òÄÔ∏è'; // Sun icon for light mode
                localStorage.setItem('theme', 'light');
            } else {
                htmlElement.classList.add('dark');
                themeToggleButton.innerText = 'üåô'; // Moon icon for dark mode
                localStorage.setItem('theme', 'dark');
            }
            // Re-render chart to apply new theme colors if it exists
            if (donutChart) {
                renderDashboard(); // Re-render dashboard to re-initialize chart with new colors
            }
        };

        // Apply saved theme on load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            themeToggleButton.innerText = 'üåô';
        } else {
            themeToggleButton.innerText = '‚òÄÔ∏è';
        }
        themeToggleButton.addEventListener('click', toggleTheme);


        // Initial UI setup for auth
        updateAuthUI();

        // Initialize Firebase and set up listeners
        window.onload = async () => {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            document.getElementById('modal-close-button').addEventListener('click', hideNotificationModal);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    authSection.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                    document.getElementById('loading-spinner').classList.add('hidden'); // Hide loading spinner if it's still there
                    showSection(activeTab + '-section'); // Show initial tab
                    setupFirestoreListeners(); // Set up Firestore listeners
                    
                    // Show logout button
                    if (logoutButtonContainer) {
                        logoutButtonContainer.innerHTML = `
                            <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition-all duration-200 shadow-md">
                                Logout
                            </button>
                        `;
                        document.getElementById('logout-button').addEventListener('click', async () => {
                            try {
                                await signOut(auth); // Use signOut from firebase/auth
                                // onAuthStateChanged will handle UI update
                            } catch (error) {
                                console.error("Error logging out:", error);
                                showNotificationModal('Gagal logout. Silakan coba lagi.');
                            }
                        });
                    }
                } else {
                    // User is logged out or not authenticated
                    userId = null; // Clear userId
                    isAuthReady = false;
                    authSection.classList.remove('hidden');
                    mainAppContent.classList.add('hidden');
                    document.getElementById('loading-spinner').classList.add('hidden'); // Hide loading spinner
                    
                    // Hide logout button
                    if (logoutButtonContainer) {
                        logoutButtonContainer.innerHTML = '';
                    }

                    // Attempt anonymous sign-in if no user and no custom token provided initially
                    // This is a fallback to allow the app to function if no explicit login is done.
                    // If you want strictly email/password, remove this anonymous sign-in block.
                    if (!initialAuthToken) { // Only try anonymous if no custom token was meant to be used
                        try {
                            await signInAnonymously(auth);
                            // onAuthStateChanged will fire again with the new anonymous user
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            // If even anonymous sign-in fails, create a temporary user ID
                            userId = crypto.randomUUID(); // Fallback to a random UUID if all else fails
                            showNotificationModal('Gagal masuk ke Firebase. Data mungkin tidak disimpan atau dimuat. Coba lagi nanti.');
                            isAuthReady = true; // Mark as ready even if anonymous failed, to show UI
                            document.getElementById('loading-spinner').classList.add('hidden');
                            showSection(activeTab + '-section');
                            setupFirestoreListeners(); // Try to setup listeners with fallback userId
                        }
                    }
                }
            });

            // Attach navigation button listeners (these are inside mainAppContent, so they'll be active when visible)
            // These listeners need to be attached only once, outside of onAuthStateChanged,
            // or ensure they are idempotent. For simplicity, they are here.
            document.getElementById('nav-dashboard').addEventListener('click', () => showSection('dashboard-section'));
            document.getElementById('nav-calculator').addEventListener('click', () => showSection('calculator-section'));
            document.getElementById('nav-dailyTarget').addEventListener('click', () => showSection('dailyTarget-section'));
            document.getElementById('nav-journal').addEventListener('click', () => showSection('journal-section'));
            document.getElementById('nav-strategy').addEventListener('click', () => showSection('strategy-section')); // New listener for strategy tab
            document.getElementById('nav-calendar').addEventListener('click', () => showSection('calendar-section'));
        };
    </script>
</body>
</html>
