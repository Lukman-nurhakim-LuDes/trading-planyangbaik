<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Rencana Trading</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .view { display: none; }
        .view.active { display: block; }
        /* Ensure calendar and news widgets take full height */
        #calendar-view, #news-view, .tradingview-widget-container {
            height: 100%;
            width: 100%;
        }
        .countdown-box {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .countdown-box .time {
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1;
            color: #3b82f6;
        }
        .countdown-box .label {
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-20 lg:w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-center lg:justify-start p-4 lg:p-6 border-b border-gray-200 dark:border-gray-700">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    <h1 class="hidden lg:block ml-3 text-xl font-bold text-gray-800 dark:text-white">TradePlan</h1>
                </div>
                <ul id="nav-menu" class="mt-6">
                    <li data-view="dashboard" class="nav-item active-nav"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Dasbor</span></a></li>
                    <li data-view="journal" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="book-open" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Jurnal</span></a></li>
                    <li data-view="plan" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="list-checks" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Rencana</span></a></li>
                    <li data-view="news" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="newspaper" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Berita</span></a></li>
                    <li data-view="calendar" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="calendar-days" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Kalender</span></a></li>
                    <li data-view="calculator" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="calculator" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Kalkulator</span></a></li>
                    <li data-view="profile" class="nav-item"><a href="#" class="flex items-center justify-center lg:justify-start p-4 text-sm font-medium"><i data-lucide="user-circle" class="w-6 h-6"></i><span class="hidden lg:block ml-4">Profil</span></a></li>
                </ul>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="hidden lg:block mb-4">
                    <p id="profile-name-display" class="font-semibold text-gray-800 dark:text-gray-100">Trader</p>
                    <p id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400 break-words">Loading...</p>
                </div>
                <button id="theme-toggle" class="w-full flex items-center justify-center lg:justify-start p-3 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <!-- Content generated by JS -->
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto">
            <!-- Loading Spinner -->
            <div id="loading-view" class="flex items-center justify-center h-full">
                <p class="text-lg text-gray-700 dark:text-gray-300">Memuat data...</p>
            </div>

            <div id="dashboard-view" class="view p-4 md:p-6 space-y-6"></div>
            <div id="journal-view" class="view p-4 md:p-6 space-y-6"></div>
            <div id="plan-view" class="view p-4 md:p-6 space-y-6"></div>
            <div id="news-view" class="view p-4 md:p-6 space-y-6"></div>
            <div id="calendar-view" class="view p-0 md:p-2 h-full"></div>
            <div id="calculator-view" class="view p-4 md:p-6 space-y-6"></div>
            <div id="profile-view" class="view p-4 md:p-6 space-y-6"></div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyAPKJfQpYiZkFoIdvZaI2cAQ-Z50mu_gM8",
            authDomain: "trading-plan-416fb.firebaseapp.com",
            projectId: "trading-plan-416fb",
            storageBucket: "trading-plan-416fb.appspot.com",
            messagingSenderId: "140608805879",
            appId: "1:140608805879:web:6ce3def86c9689c2786cf2",
            measurementId: "G-5EGLDF7228"
        };
        const appId = 'trading-plan-416fb';

        // --- Inisialisasi Aplikasi ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let trades = [];
        let plan = {};
        let profile = {};
        let pnlChart = null;
        let winLossChart = null;
        
        // --- State and DOM Elements ---
        const views = {
            dashboard: document.getElementById('dashboard-view'),
            journal: document.getElementById('journal-view'),
            plan: document.getElementById('plan-view'),
            news: document.getElementById('news-view'),
            calendar: document.getElementById('calendar-view'),
            calculator: document.getElementById('calculator-view'),
            profile: document.getElementById('profile-view'),
        };
        const navMenu = document.getElementById('nav-menu');
        const mainContent = document.getElementById('main-content');
        const loadingView = document.getElementById('loading-view');
        const profileNameDisplay = document.getElementById('profile-name-display');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Templating Functions ---
        const createDashboardHTML = () => `<h1 class="text-3xl font-bold">Dasbor Performa</h1><div id="dashboard-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div><div id="dashboard-progress"></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h3 class="font-semibold mb-4">P/L per Trade</h3><canvas id="pnlChart"></canvas></div><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h3 class="font-semibold mb-4">Distribusi Win/Loss</h3><canvas id="winLossChart"></canvas></div></div>`;
        const createJournalHTML = () => `<div class="flex justify-between items-center"><h1 class="text-3xl font-bold">Jurnal Trading</h1><button id="add-trade-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg"><i data-lucide="plus-circle" class="w-5 h-5"></i> Tambah Trade</button></div><form id="trade-form" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4"></form><div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3">Tanggal</th><th class="px-6 py-3">Pair</th><th class="px-6 py-3">Hasil</th><th class="px-6 py-3">P/L ($)</th><th class="px-6 py-3">Alasan</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="journal-table-body"></tbody></table></div>`;
        const createPlanHTML = () => `<h1 class="text-3xl font-bold">Rencana Trading Anda</h1><form id="plan-form" class="space-y-8"></form>`;
        const createNewsHTML = () => `<h1 class="text-3xl font-bold mb-6">Berita Pasar & Hitung Mundur</h1><div class="mb-8"><h2 class="text-2xl font-semibold mb-4">Hitung Mundur Berita Penting</h2><div id="countdown-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div id="xauusd-news-container"></div><div id="btcusd-news-container"></div></div>`;
        const createCalculatorHTML = () => `<h1 class="text-3xl font-bold">Kalkulator Risiko</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4"><h2 class="text-xl font-semibold">Parameter</h2><div id="calculator-inputs"></div></div><div id="calculator-result" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow flex flex-col justify-center items-center"></div></div>`;
        const createProfileHTML = () => `<h1 class="text-3xl font-bold">Profil Pengguna</h1><div class="max-w-md"><form id="profile-form" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4"><div><label class="block text-sm font-medium">Nama Pengguna</label><input type="text" name="name" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border rounded-md"></div><button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg">Simpan Profil</button></form></div>`;

        // --- Rendering Functions ---
        function renderDashboard() { /* ... (no changes) ... */ }
        function renderJournal() { /* ... (no changes) ... */ }
        function renderJournalTable() { /* ... (no changes) ... */ }
        function renderPlan() { /* ... (no changes) ... */ }
        function renderCalculator() { /* ... (no changes) ... */ }
        function renderProfile() { /* ... (no changes) ... */ }
        
        function renderNews() {
            views.news.innerHTML = createNewsHTML();
            
            // --- Render Countdown Timers ---
            // Anda bisa mengganti event ini dengan berita penting berikutnya
            const upcomingEvents = [
                { name: "Non-Farm Payrolls (US)", date: "2025-08-01T19:30:00", id: "nfp-countdown" },
                { name: "CPI Report (US)", date: "2025-08-14T19:30:00", id: "cpi-countdown" }
            ];

            const countdownContainer = document.getElementById('countdown-container');
            countdownContainer.innerHTML = upcomingEvents.map(event => `
                <div class="countdown-box">
                    <h3 class="text-lg font-semibold mb-2">${event.name}</h3>
                    <div id="${event.id}" class="flex justify-center gap-4"></div>
                </div>
            `).join('');
            
            upcomingEvents.forEach(event => startCountdown(event.id, event.date));
            
            // --- Render News Widgets ---
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            createTradingViewNewsWidget('xauusd-news-container', 'Berita XAU/USD', ["OANDA:XAUUSD"]);
            createTradingViewNewsWidget('btcusd-news-container', 'Berita BTC/USD', ["COINBASE:BTCUSD"]);
        }

        function renderCalendar() { /* ... (no changes) ... */ }

        // --- Calculation and Logic Functions ---
        function calculateStats() { /* ... (no changes) ... */ }
        function renderCharts(stats) { /* ... (no changes) ... */ }
        function handleCalculateRisk() { /* ... (no changes) ... */ }

        function createTradingViewNewsWidget(containerId, title, symbols) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            
            container.innerHTML = `<h2 class="text-2xl font-semibold mb-4">${title}</h2><div id="${containerId}-widget" class="h-[500px]"></div>`;
            
            new TradingView.widget({
                "container_id": `${containerId}-widget`,
                "width": "100%",
                "height": "100%",
                "symbols": symbols,
                "feedMode": "market",
                "colorTheme": theme,
                "isTransparent": true,
                "displayMode": "regular",
                "locale": "id"
            });
        }
        
        function startCountdown(elementId, targetDate) {
            const countDownDate = new Date(targetDate).getTime();
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const container = document.getElementById(elementId);
                if (container) {
                    if (distance < 0) {
                        clearInterval(interval);
                        container.innerHTML = `<div class="text-xl font-bold text-green-500">Berita Telah Dirilis!</div>`;
                    } else {
                        container.innerHTML = `
                            <div><div class="time">${days}</div><div class="label">Hari</div></div>
                            <div><div class="time">${hours}</div><div class="label">Jam</div></div>
                            <div><div class="time">${minutes}</div><div class="label">Menit</div></div>
                            <div><div class="time">${seconds}</div><div class="label">Detik</div></div>
                        `;
                    }
                } else {
                     clearInterval(interval);
                }
            }, 1000);
        }

        // --- Event Handlers ---
        function handleNavigation(e) {
            e.preventDefault();
            const navItem = e.target.closest('.nav-item');
            if (!navItem) return;
            const viewName = navItem.dataset.view;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active-nav'));
            navItem.classList.add('active-nav');
            Object.values(views).forEach(view => view.classList.remove('active'));
            views[viewName].classList.add('active');
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'journal': renderJournal(); break;
                case 'plan': renderPlan(); break;
                case 'news': renderNews(); break;
                case 'calendar': renderCalendar(); break;
                case 'calculator': renderCalculator(); break;
                case 'profile': renderProfile(); break;
            }
            lucide.createIcons();
        }
        
        async function handleAddTrade(e) { /* ... (no changes) ... */ }
        async function handleDeleteTrade(e) { /* ... (no changes) ... */ }
        async function handleSavePlan(e) { /* ... (no changes) ... */ }
        async function handleSaveProfile(e) { /* ... (no changes) ... */ }

        // --- Initialization ---
        function initApp() {
            const themeToggle = document.getElementById('theme-toggle');
            
            const setTheme = (isDark) => {
                const icon = isDark ? 'sun' : 'moon';
                themeToggle.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span class="hidden lg:block ml-4">Ganti Tema</span>`;
                lucide.createIcons();
            };

            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                setTheme(isDark);
                
                if (views.calendar.classList.contains('active')) renderCalendar();
                if (views.news.classList.contains('active')) renderNews();
            });
            
            setTheme(document.documentElement.classList.contains('dark')); // Set initial theme icon

            navMenu.addEventListener('click', handleNavigation);
            mainContent.addEventListener('click', handleDeleteTrade);
        }

        // --- Firebase Auth and Data Loading ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID: ${userId}`;
                
                // Load all user data...
                const tradesRef = collection(db, 'artifacts', appId, 'users', userId, 'trades');
                onSnapshot(query(tradesRef), (snapshot) => { trades = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })); if (views.dashboard.classList.contains('active')) renderDashboard(); if (views.journal.classList.contains('active')) renderJournalTable(); });
                const planRef = doc(db, 'artifacts', appId, 'users', userId, 'plan', 'mainPlan');
                onSnapshot(planRef, (doc) => { plan = doc.exists() ? doc.data() : { monthlyTarget: 2000 }; if (views.dashboard.classList.contains('active')) renderDashboard(); if (views.plan.classList.contains('active')) renderPlan(); });
                const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'mainProfile');
                onSnapshot(profileRef, (doc) => { profile = doc.exists() ? doc.data() : { name: 'Trader' }; profileNameDisplay.textContent = profile.name; if (views.profile.classList.contains('active')) renderProfile(); });

                loadingView.style.display = 'none';
                views.dashboard.classList.add('active');
                renderDashboard();
                lucide.createIcons();
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        initApp();
    </script>
    <!-- TradingView Ticker Tape Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
